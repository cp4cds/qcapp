<br>
<br>
{% extends 'qcapp/base.html' %}
{% load static %}

{% block extrahead %}{{ block.super }}
     <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>

{% endblock %}

{% block title %}
<h1>Dataset QC: {{page_title}}</h1>
{% endblock %}

{% block contents %}

<form action="{% url 'variable-dataset-qc' page_title %}" method="post">
    {% csrf_token %}


    <table class="table table-hover">

        <thead>
        <tr>
            {% for facet in facets %}

            <th>{{facet|capfirst}}</th>
            {% endfor %}
        </thead>
        <tbody>

        <tr>
            {% for facet, values in facets.iteritems %}
            <td>
                <select class="facet-filter" id={{facet}} name="{{facet}}">
                    <!--somewhere here set the default width using css-->
                    <option value="All">All</option>
                    {% for item in values %}
                    <option value={{item}}>{{item}}</option>
                    <!--change only {{item}} to display institute+model-->
                    {% endfor %}
                </select>
            </td>
            {% endfor %}
        </tr>

        </tbody>

    </table>

    <input value="Get results" type="submit" class="btn btn-success" id="file_qc_list">
    <button type="button" class="btn btn-info" id="clear_filters"> Reset all filters</button>
</form>



<h2>Datasets with QC errors  </h2>


<table class="table table-hover">
<thead>
 <tr> <th>Dataset</th> <th>Max global errors</th> <th>Max variable errors</th> <th>Max other errors</th> </tr>
</thead>
<tbody>

    {% for ds, error in errors.iteritems %}
       <tr>
           <!--<th><a href="http://127.0.0.1:8000/variable-qc/{{error.file.ncfile}}">-->
               <!--{{error.file.dataset.institute}} {{error.file.dataset.model}} {{error.file.dataset.experiment}}-->
               <!--{{error.file.dataset.frequency}} {{error.file.dataset.realm}} {{error.file.dataset.cmor_table}}-->
               <!--{{error.file.dataset.ensemble}}-->
                <!--</a>-->
           <!--</th>-->
           <th>
               <a href="http://127.0.0.1:8000/variable-qc/{{error.0.file.ncfile}}">
               {{ ds }}
               </a>
           </th>
           <th></th><th></th><th></th>
        <!--{% for err in max_errors %}-->
           <!--<th></th> {{ err.global }} <th> {{ err.variable }} </th> {{ err.other }} <th></th>-->
        <!--{% endfor %}-->
       </tr>
    {% endfor %}

</tbody>

</table>




    <script>
        $('.facet-filter').change(function () {
            var model = $('#models').val()
            var experiment = $('#experiments').val()
            var target = "/facet-filter/" + model + '/' + experiment
            $.get(target, function (data) {
                // Handle data from server and populate dropdown menus
                // Declare vars
                var i,j
                var model_list
                var experiment_list

                // Initialise innerHTML strings for dropdown with All option
                model_list = "<option value='All'>All</option>"
                experiment_list = "<option value='All'>All</option>"

                // Loop JSON to build html strings
                for (i=0; i<data.models.length; i++){
                    model_list = model_list.concat("<option value=" + data.models[i] + ">" + data.models[i] + "</option>")
                }
                for (j=0; j<data.experiments.length; j++){
                    experiment_list = experiment_list.concat("<option value=" + data.experiments[j] + ">" + data.experiments[j] + "</option>")
                }

                // Populate selection dropdowns
                $('#models').html(model_list)
                $('#experiments').html(experiment_list)

                // Choose selected value
                $('#models').val(model)
                $('#experiments').val(experiment)


            })
        })

        $('#clear_filters').click(function () {
            $('#models').val('All').trigger('change')
            $('#experiments').val('All').trigger('change')
        })




    </script>

{% endblock %}
