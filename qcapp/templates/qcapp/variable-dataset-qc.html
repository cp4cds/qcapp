<br>
<br>
{% extends 'qcapp/base.html' %}
{% load static %}

{% block extrahead %}{{ block.super }}
     <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>

{% endblock %}

{% block title %}
<h1>Dataset QC: {{page_title}}</h1>
{% endblock %}

{% block contents %}

<form action="{% url 'variable-dataset-qc' variable %}" method="post">
    {% csrf_token %}


    <table class="table table-hover">

        <thead>
        <tr>
            {% for facet in facets %}

            <th>{{facet|capfirst}}</th>
            {% endfor %}
        </thead>
        <tbody>

        <tr>
            {% for facet, values in facets.iteritems %}
            <td>
                <select class="facet-filter" id={{facet}} name="{{facet}}">
                    <!--somewhere here set the default width using css-->
                    <!--NEED TO ONLY DISPLAY BELOW IF NO SELECTION HAS BEEN MADE-->
                    <option value="All">All</option>

                    {% for item in values %}
                    <option value={{item}}>{{item}}</option>
                    {% endfor %}

                </select>
            </td>
            {% endfor %}
        </tr>

        </tbody>

    </table>

    <input value="Get results" type="submit" class="btn btn-success" id="file_qc_list">
    <button type="button" class="btn btn-info" id="clear_filters"> Reset all filters</button>
</form>



<h2>Datasets with QC errors ( {{errors|length}} )</h2>

<!--<h3>Model: {{ facets.model }}</h3> <h3>Experiment {{ facets.experiment }}</h3>-->

<table class="table table-hover">
<thead>
<tr> <th>Dataset</th> <th>No. of files in dataset</th> <th> QC Score </th> <th>Max global errors</th> <th>Max variable errors</th> <th>Max other errors</th> </tr>
</thead>
<tbody>

    {% for ds, error in errors.iteritems %}
       <tr>
           <th>
               <a href="http://127.0.0.1:8000/variable-qc/{{error.5.file.ncfile}}">
               {{ ds }}
               </a>
           </th>
           <th> {{ error.0 }} </th> <th> {{ error.4 }} </th> <th>{{ error.1 }} </th> <th>{{ error.2 }} </th> <th>{{ error.3 }}</th>
        <!--{% for err in max_errors %}-->
           <!--<th></th> {{ err.global }} <th> {{ err.variable }} </th> {{ err.other }} <th></th>-->
        <!--{% endfor %}-->
       </tr>
    {% endfor %}

</tbody>

</table>




    <script>
        $('.facet-filter').change(function () {
            var model = $('#model').val()
            var experiment = $('#experiment').val()
            var target = "/facet-filter/" + model + '/' + experiment
            $.get(target, function (data) {
                // Handle data from server and populate dropdown menus
                // Declare vars
                var i,j
                var model_list
                var experiment_list

                // Initialise innerHTML strings for dropdown with All option
                model_list = "<option value='All'> All </option>"
                experiment_list = "<option value='All'> All </option>"

                // Loop JSON to build html strings
                for (i=0; i<data.model.length; i++){
                    model_list = model_list.concat("<option value=" + data.model[i] + ">" + data.model[i] + "</option>")
                }
                for (j=0; j<data.experiment.length; j++){
                    experiment_list = experiment_list.concat("<option value=" + data.experiment[j] + ">" + data.experiment[j] + "</option>")
                }

                // Populate selection dropdowns
                $('#model').html(model_list)
                $('#experiment').html(experiment_list)

                // Choose selected value
                $('#model').val(model)
                $('#experiment').val(experiment)


            })
        })

        $('#clear_filters').click(function () {
            $('#model').val('All').trigger('change')
            $('#experiment').val('All').trigger('change')
        })




    </script>

{% endblock %}
